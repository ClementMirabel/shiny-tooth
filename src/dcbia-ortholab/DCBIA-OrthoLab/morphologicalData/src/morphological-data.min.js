angular.module("morphological-data",[]),angular.module("morphological-data").controller("morphologicalData",["$scope","$http","dcbia","clusterauth",function(a,b,c,d){d.getUser().then(function(b){a.user=b}),a.morphologicalDataSectionDisplay={section:0},a._=_,a.morphologicalDataCollection={newCollection:{items:[],type:"morphologicalDataCollection",name:""},collections:[],collectionsProperties:{defaultMorphologicalDataCollection:{class:""}},section:-1},a.morphologicalData={data:{}},a.defaultMorphologicalDataCollection={_id:"defaultMorphologicalDataCollection",name:"All morphological data",type:"morphologicalDataCollection",items:0},a.morphologicalDataCollection.getMorphologicalDataCollections=function(){return c.getMorphologicalDataCollections().then(function(b){delete a.morphologicalDataCollection.selectedCollection,a.morphologicalDataCollection.collections=b.data,_.each(a.morphologicalDataCollection.collections,function(b){a.morphologicalDataCollection.collectionsProperties[b._id]={class:""}})}).catch(console.error)},a.morphologicalDataCollection.create=function(b){c.createMorphologicalDataCollection(b).then(function(b){return a.morphologicalDataCollection.getMorphologicalDataCollections()}).catch(console.error)},a.morphologicalDataCollection.selectCollection=function(b){a.morphologicalDataCollection.selectedCollection&&(a.morphologicalDataCollection.collectionsProperties[a.morphologicalDataCollection.selectedCollection._id].class=""),a.morphologicalDataCollection.selectedCollection=b,a.morphologicalDataCollection.collectionsProperties[b._id].class="alert alert-info"},a.morphologicalDataCollection.getDataCollectionKeys=function(a){var b={};return _.each(a,function(a){_.extend(b,a)}),b._id&&delete b._id,b._rev&&delete b._rev,b._attachments&&delete b._attachments,b.attachments={},_.keys(b)},a.morphologicalDataCollection.select=function(b){a.morphologicalDataCollection.selectCollection(b);var d;return d="defaultMorphologicalDataCollection"===b._id?c.getAllMorphologicalData().then(function(b){return a.defaultMorphologicalDataCollection.items=_.map(b.data,function(a){return a.patientId||(a.patientId="null"),{_id:a._id}}),b}):c.getMorphologicalData(b._id),d.then(function(b){var c=b.data;a.morphologicalDataCollection.selectedCollectionData=_.map(c,function(a){return a._attachments&&_.extend(a,{attachments:_.keys(a._attachments)}),a}),a.morphologicalDataCollection.selectedCollectionDataKeys=a.morphologicalDataCollection.getDataCollectionKeys(c)}).catch(console.error)},a.morphologicalDataCollection.delete=function(b){confirm("Are you sure you want to delete the collection?")&&c.deleteMorphologicalDataCollection(b._id).then(function(b){return a.morphologicalDataCollection.getMorphologicalDataCollections()}).catch(console.error)},a.morphologicalDataCollection.download=function(a){console.log("TODO")},a.morphologicalDataCollection.addMorphologicalData=function(){void 0==a.morphologicalData.data.date&&(a.morphologicalData.data.date=new Date);var b={patientId:a.morphologicalData.data.patientId,date:a.morphologicalData.data.date,owners:[],type:"morphologicalData"};b.owners.push({user:a.user.email}),c.createMorphologicalData(b).then(function(b){return a.morphologicalDataCollection.selectedCollection.items.push({_id:b.data.id}),Promise.all([c.addAttachement(b.data.id,a.morphologicalData.data.file.name,a.morphologicalData.data.file),c.updateMorphologicalDataCollection(a.morphologicalDataCollection.selectedCollection)])}).then(function(a){console.log(a)}).catch(function(a){alert(JSON.stringify(a))})},a.morphologicalData.delete=function(a){console.log(a)},a.morphologicalData.viewAttachment=function(b,d){a.morphologicalData.surface=null,c.getAttachement(b._id,d,"arraybuffer").then(function(b){a.morphologicalData.surface=b.data})},a.morphologicalDataCollection.getMorphologicalDataCollections()}]);